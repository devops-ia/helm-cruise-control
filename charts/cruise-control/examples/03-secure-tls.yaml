# Secure Configuration Example with TLS
# This example shows a secure setup with:
# - TLS configuration
# - Secure communication with Kafka
# - Secret management
# - Security context settings
# - Network policies

image:
  repository: ghcr.io/devops-ia/kafka-cruise-control
  tag: "latest"
  pullPolicy: IfNotPresent

replicaCount: 1

resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

service:
  type: ClusterIP
  port: 80
  targetPort: 9090

# Secret management
secrets:
  - name: kafka-certificates
    data:
      kafka.keystore.jks: |-
        ${KAFKA_KEYSTORE_DATA}
      kafka.truststore.jks: |-
        ${KAFKA_TRUSTSTORE_DATA}
      cert-password: ${CERT_PASSWORD}

envFromSecrets:
  KEYSTORE_PASSWORD:
    name: kafka-certificates
    key: cert-password
  TRUSTSTORE_PASSWORD:
    name: kafka-certificates
    key: cert-password

volumeMounts:
  - name: kafka-certs
    mountPath: /etc/kafka/certs
    readOnly: true

volumes:
  - name: kafka-certs
    secret:
      secretName: kafka-certificates

# Security context
podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsNonRoot: true

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

# Network policy
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: kafka
      ports:
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: kafka
      ports:
        - protocol: TCP
          port: 9093

# Configure default settings for all clusters
clustersDefaults:
  # JAAS configuration for secure authentication
  jaas:
    enabled: true
    config: |
      KafkaClient {
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="cruise-control"
        password="${KAFKA_PASSWORD}";
      };

  # Cluster configuration
  cluster:
    min.insync.replicas: 2

  # Capacity configuration
  capacity:
    type: capacity
    config: |
      {
        "brokerCapacities":[
          {
            "brokerId": "-1",
            "capacity": {
              "DISK": "100000",
              "CPU": "100",
              "NW_IN": "125000",
              "NW_OUT": "125000"
            },
            "doc": "Secure cluster capacity configuration."
          }
        ]
      }

  # Cruise Control configuration with TLS
  config:
    # METADATA CLIENT
    bootstrap.servers: "kafka-broker:9093"
    client.id: "cruise-control-secure"
    security.protocol: "SSL"

    # LOAD MONITOR
    broker.metric.sample.store.topic: "__KafkaCruiseControlModelTrainingSamples"
    partition.metric.sample.store.topic: "__KafkaCruiseControlPartitionMetricSamples"
    metric.sampler.class: com.linkedin.kafka.cruisecontrol.monitor.sampling.prometheus.PrometheusMetricSampler
    prometheus.server.endpoint: thanos-query.prometheus:9090
    sample.store.topic.replication.factor: 2

    # ANOMALY DETECTOR
    anomaly.detection.interval.ms: "10000"
    self.healing.enabled: false

    # WEBSERVER
    webserver.http.port: 9090
    webserver.http.address: 0.0.0.0
    webserver.accesslog.enabled: true

  # Log4j configuration
  log4j:
    rootLogger.level: INFO
    logger.cruisecontrol.level: info

# Configure single secure cluster
clusters:
  secure-cluster: {}
